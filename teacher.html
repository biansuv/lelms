<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Teacher Dashboard – Literacy LMS</title>

<link rel="stylesheet" href="base.css">
<link rel="stylesheet" href="footer.css">
</head>


<body>

<!-- ================= ATTENDANCE ================= -->
<div class="section">
<h3>Mark Attendance</h3>

<p><b>Date:</b> <span id="attDate"></span></p>

<select id="attStatus">
    <option value="">-- Select Status --</option>
    <option value="Present">Present</option>
    <option value="Absent">Absent</option>
    <option value="Leave">Leave</option>
</select>

<button class="upload-btn" onclick="markAttendance()">Submit Attendance</button>

<div id="attMsg" class="empty"></div>
</div>



<!-- ================= ANNOUNCEMENTS ================= -->
<div class="section">

    <button class="upload-btn" id="annToggleBtn" onclick="toggleAnnouncements()">
        Hide Announcements
    </button>

    <div id="annList"></div>
    <div id="annEmpty" class="empty"></div>

</div>


<!-- ================= UPLOAD NOTES ================= -->
<div class="section">
<h3 class="section-header">
    Notes
<button class="toggle-btn" onclick="toggleSection('notesBody', this)">▲</button>
</h3>

<div id="notesBody" style="display:none;">

<label>Class</label>
<select id="className">
    <option value="">-- Select Class --</option>
</select>

<label>Subject</label>
<select id="subject">
    <option value="">-- Select Subject --</option>
</select>

<label>Title</label>
<input type="text" id="title">

<label>Description</label>
<textarea id="description" rows="3"></textarea>

<label>File</label>
<input type="file" id="file">

<button class="upload-btn" onclick="uploadNote()">Upload Notes</button>
</div>
</div>


<!-- ================= UPLOAD HOMEWORK ================= -->
<div class="section">

<h3 class="section-header">
    Homework
    <button class="toggle-btn" onclick="toggleSection('hwBody', this)">▲</button>
</h3>

<div id="hwBody" style="display:none;">

<label>Class</label>
<select id="hwClass">
    <option value="">-- Select Class --</option>
</select>

<label>Subject</label>
<select id="hwSubject">
    <option value="">-- Select Subject --</option>
</select>

<label>Homework Title</label>
<input type="text" id="hwTitle">

<label>Description</label>
<textarea id="hwDescription" rows="3"></textarea>

<label>File (optional)</label>
<input type="file" id="hwFile">

<button class="upload-btn" onclick="uploadHomework()">Upload Homework</button>

</div>  <!-- ✅ hwBody -->
</div>  <!-- ✅ section -->


<!-- ================= MY UPLOADED NOTES ================= -->
<div class="section">

<h3 class="section-header">
    My Uploaded Notes
    <button class="toggle-btn" onclick="toggleSection('myNotesBody', this)">▲</button>
</h3>

<div id="myNotesBody" style="display:none;">

<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>File</th>
<th>Uploaded On</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="notesTable"></tbody>
</table>

<div id="notesEmpty" class="empty"></div>

</div>  <!-- ✅ myNotesBody -->
</div>  <!-- ✅ section -->


<!-- ================= MY UPLOADED HOMEWORK ================= -->
<div class="section">

<h3 class="section-header">
    My Uploaded Homework
    <button class="toggle-btn" onclick="toggleSection('myHWBody', this)">▲</button>
</h3>

<div id="myHWBody" style="display:none;">

<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>File</th>
<th>Assigned On</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="hwTable"></tbody>
</table>

<div id="hwEmpty" class="empty"></div>

</div>  <!-- ✅ myHWBody -->
</div>  <!-- ✅ section -->


<!-- ✅ SHARED SCRIPTS (ORDER MATTERS) -->
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="header.js"></script>

<script>
/* =====================================================
   ROUTE PROTECTION
===================================================== */
const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
if (!loggedUser || loggedUser.role !== "teacher") {
    alert("Unauthorized access");
    location.href = "login.html";
}

/* ✅ Render shared header */
renderHeader("Teacher Dashboard");

/* =====================================================
   UPLOAD NOTE
===================================================== */
function uploadNote() {
    const className = classNameEl.value;
    const subject = subjectEl.value;
    const title = titleEl.value.trim();
    const description = descriptionEl.value.trim();
    const fileInput = fileEl;

    if (!className || !subject || !title || !fileInput.files.length) {
        alert("Class, Subject, Title and File are required");
        return;
    }

    const reader = new FileReader();
    const file = fileInput.files[0];

    reader.onload = function () {
        let materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];

        materials.push({
            id: Date.now(),
            className,
            subject,
            title,
            description,
            fileName: file.name,
            fileData: reader.result,
            uploadedBy: loggedUser.login_id,
            uploaderName: loggedUser.name,
            uploadedOn: new Date().toLocaleDateString()
        });

        localStorage.setItem("studyMaterials", JSON.stringify(materials));

        classNameEl.value = "";
        subjectEl.value = "";
        titleEl.value = "";
        descriptionEl.value = "";
        fileInput.value = "";

        loadMyNotes();
    };

    reader.readAsDataURL(file);
}


/* =====================================================
   UPLOAD HOMEWORK
===================================================== */
function uploadHomework() {
    const className = hwClass.value;
    const subject = hwSubject.value;
    const title = hwTitle.value.trim();
    const description = hwDescription.value.trim();
    const fileInput = hwFile;

    if (!className || !subject || !title) {
        alert("Class, Subject and Homework Title are required");
        return;
    }

    const reader = new FileReader();
    const file = fileInput.files[0];

    reader.onload = function () {
        const homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];

        homeworks.push({
            id: Date.now(),
            className,
            subject,
            title,
            description,
            fileName: file ? file.name : "",
            fileData: file ? reader.result : "",
            uploadedBy: loggedUser.login_id,
            uploaderName: loggedUser.name,
            assignedOn: new Date().toLocaleDateString()
        });

        localStorage.setItem("homeworks", JSON.stringify(homeworks));

        hwClass.value = "";
        hwSubject.value = "";
        hwTitle.value = "";
        hwDescription.value = "";
        hwFile.value = "";

        loadMyHomework();
    };

    if (file) {
        reader.readAsDataURL(file);
    } else {
        reader.onload();
    }
}

/* =====================================================
   LOAD MY HOMEWORK
===================================================== */
function loadMyHomework() {
    const homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];
    const myHW = homeworks.filter(h => h.uploadedBy === loggedUser.login_id);

    hwTable.innerHTML = "";
    hwEmpty.textContent = "";

    if (!myHW.length) {
        hwEmpty.textContent = "No homework uploaded yet.";
        return;
    }

    myHW.forEach(h => {
        hwTable.innerHTML += `
        <tr>
            <td data-label="Title">${h.title}</td>
            <td data-label="Class">${h.className}</td>
            <td data-label="Subject">${h.subject}</td>
            <td data-label="File">
                ${h.fileName
                    ? `<a href="${h.fileData}" download="${h.fileName}">${h.fileName}</a>`
                    : "-"
                }
            </td>
            <td data-label="Assigned On">${h.assignedOn}</td>
            <td data-label="Actions">
                <button class="delete-btn" onclick="deleteHomework(${h.id})">Delete</button>
            </td>
        </tr>`;
    });
}

/* =====================================================
   DELETE HOMEWORK
===================================================== */
function deleteHomework(id) {
    if (!confirm("Delete this homework?")) return;

    let homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];
    homeworks = homeworks.filter(h => h.id !== id);
    localStorage.setItem("homeworks", JSON.stringify(homeworks));

    loadMyHomework();
}

/* =====================================================
   LOAD OWN NOTES
===================================================== */
function loadMyNotes() {
    const materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];
    const myNotes = materials.filter(m => m.uploadedBy === loggedUser.login_id);

    notesTable.innerHTML = "";
    notesEmpty.textContent = "";

    if (!myNotes.length) {
        notesEmpty.textContent = "No uploads yet.";
        return;
    }

    myNotes.forEach(m => {
        notesTable.innerHTML += `
        <tr>
            <td data-label="Title">${m.title}</td>
            <td data-label="Class">${m.className}</td>
            <td data-label="Subject">${m.subject}</td>
            <td data-label="File">
                <a href="${m.fileData}" download="${m.fileName}">${m.fileName}</a>
            </td>
            <td data-label="Uploaded On">${m.uploadedOn}</td>
            <td data-label="Actions">
                <button class="delete-btn" onclick="deleteNote(${m.id})">Delete</button>
            </td>
        </tr>`;
    });
}

/* =====================================================
   DELETE NOTE
===================================================== */
function deleteNote(id) {
    if (!confirm("Delete this note?")) return;

    let materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];
    materials = materials.filter(m => m.id !== id);
    localStorage.setItem("studyMaterials", JSON.stringify(materials));

    loadMyNotes();
}

/*-----To See All Announcements------*/

function formatDateToDDMonYYYY(timeString) {

    // New ISO format
    if (timeString && timeString.includes("T")) {
        const d = new Date(timeString);
        return d.toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        }).replace(",", "");
    }

    // Old format: DD/MM/YYYY, HH:mm:ss
    if (timeString && timeString.includes("/")) {
        const [datePart, timePart] = timeString.split(", ");
        const [dd, mm, yyyy] = datePart.split("/");

        const d = new Date(`${yyyy}-${mm}-${dd}T${timePart}`);

        return d.toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        }).replace(",", "");
    }

    return timeString || "";
}

function loadTeacherAnnouncements() {
    const anns = JSON.parse(localStorage.getItem("announcements")) || [];

    const relevant = anns.filter(a =>
        a.active &&
        a.target &&
        a.target.teachers === true
    );

    annList.innerHTML = "";
    annEmpty.textContent = "";

    if (!relevant.length) {
        annEmpty.textContent = "No announcements available.";
        return;
    }

    relevant.forEach(a => {
        annList.innerHTML += `
            <div class="card">
                <b>${a.title}</b><br>
                ${a.message}<br>
                <small>Posted on: ${formatDateToDDMonYYYY(a.time)}</small>
            </div>
        `;
    });
}





let announcementsVisible = true;

function toggleAnnouncements() {
    announcementsVisible = !announcementsVisible;

    const annSection = document.getElementById("annList");
    const annEmpty = document.getElementById("annEmpty");
    const btn = document.getElementById("annToggleBtn");

    if (announcementsVisible) {
        annSection.style.display = "block";
        annEmpty.style.display = "block";
        btn.textContent = "Hide Announcements";
    } else {
        annSection.style.display = "none";
        annEmpty.style.display = "none";
        btn.textContent = "Show Announcements";
    }
}


/* =====================================================
   MARK ATTENDANCE
===================================================== */
const today = new Date().toISOString().split("T")[0];
document.getElementById("attDate").textContent = today;

function markAttendance() {
    const status = document.getElementById("attStatus").value;
    const msg = document.getElementById("attMsg");

    if (!status) {
        msg.textContent = "Please select attendance status.";
        return;
    }

    let attendance = JSON.parse(localStorage.getItem("attendance")) || [];

    // Prevent duplicate marking
    const alreadyMarked = attendance.find(a =>
        a.teacherId === loggedUser.login_id && a.date === today
    );

    if (alreadyMarked) {
        msg.textContent = "Attendance already marked for today.";
        return;
    }

    attendance.push({
        teacherId: loggedUser.login_id,
        teacherName: loggedUser.name,
        date: today,
        status: status,
        markedAt: new Date().toLocaleTimeString()
    });

    localStorage.setItem("attendance", JSON.stringify(attendance));

    msg.textContent = "Attendance marked successfully.";
}




/* =====================================================
   INIT
===================================================== */
const classNameEl = document.getElementById("className");
const subjectEl = document.getElementById("subject");
const titleEl = document.getElementById("title");
const descriptionEl = document.getElementById("description");
const fileEl = document.getElementById("file");
const notesTable = document.getElementById("notesTable");
const notesEmpty = document.getElementById("notesEmpty");

const hwClass = document.getElementById("hwClass");
const hwSubject = document.getElementById("hwSubject");
const hwTitle = document.getElementById("hwTitle");
const hwDescription = document.getElementById("hwDescription");
const hwFile = document.getElementById("hwFile");
const hwTable = document.getElementById("hwTable");
const hwEmpty = document.getElementById("hwEmpty");

populateClassDropdown("className");
populateSubjectDropdown("subject");
loadMyNotes();
loadTeacherAnnouncements();

populateClassDropdown("hwClass");
populateSubjectDropdown("hwSubject");
loadMyHomework();

</script>

<script src="footer.js"></script>
<script>
  renderFooter();

/* =====================================================
   Notes Roll-In Roll Out Function
===================================================== */

function toggleSection(sectionId, btn) {
    const section = document.getElementById(sectionId);

    const isHidden = section.style.display === "none";

    if (isHidden) {
        section.style.display = "block";
        btn.textContent = "▼"; // now expanded
    } else {
        section.style.display = "none";
        btn.textContent = "▲"; // now collapsed
    }
}



</script>

<script src="security.js"></script>


</body>
</html>
