<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard – Literacy LMS</title>

<link rel="stylesheet" href="base.css">
<link rel="stylesheet" href="footer.css">
</head>

<body>

<!-- ================= ANNOUNCEMENTS ================= -->
<div class="section">

<h3 class="section-header">
    Announcements
    <button class="toggle-btn"
            onclick="toggleSection('studentAnnBody', this)">
        ▲
    </button>
</h3>

<div id="studentAnnBody" class="section-body" style="display:none;">
    <div id="studentAnnouncements"></div>
    <div id="studentAnnEmpty" class="empty"></div>
</div>

</div>



<!-- ================= FILTER ================= -->
<div class="section">
<h3 class="section-header">
    Filter Notes
    <button class="toggle-btn"
            onclick="toggleSection('filterNotesBody', this)">
        ▲
    </button>
</h3>
<div id="filterNotesBody" class="section-body" style="display:none;">
<label>Subject</label>
<select id="subjectFilter" onchange="loadNotes()">
    <option value="">All Subjects</option>
</select>
</div>
</div> 

<!-- ================= NOTES ================= -->
<div class="section">
<h3 class="section-header">
    Available Notes
    <button class="toggle-btn"
            onclick="toggleSection('availableNotesBody', this)">
        ▲
    </button>
</h3>
<div id="availableNotesBody" class="section-body" style="display:none;">

<table>
<thead>
<tr>
<th>Title</th>
<th>Subject</th>
<th>Teacher</th>
<th>Description</th>
<th>File</th>
<th>Uploaded On</th>
</tr>
</thead>
<tbody id="notesTable"></tbody>
</table>

<div id="notesEmpty" class="empty"></div>
</div>
</div>
</div>

<!-- ================= HOMEWORK ================= -->
<div class="section">
<h3 class="section-header">
    Homework
    <button class="toggle-btn"
            onclick="toggleSection('homeworkBody', this)">
        ▲
    </button>
</h3>
<div id="homeworkBody" class="section-body" style="display:none;">

<table>
<thead>
<tr>
<th>Title</th>
<th>Subject</th>
<th>Teacher</th>

<th>Description</th>
<th>File</th>
<th>Assigned On</th>

</tr>
</thead>
<tbody id="hwTable"></tbody>
</table>

<div id="hwEmpty" class="empty"></div>
</div>
</div>
<!-- ✅ SHARED SCRIPTS (ORDER MATTERS) -->
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="header.js"></script>

<script>
/* =====================================================
   ROUTE PROTECTION
===================================================== */
const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));

if (!loggedUser || loggedUser.role !== "student") {
    alert("Unauthorized access");
    location.href = "login.html";
}

/* ✅ Render shared header */
renderHeader("Student Dashboard");

/* =====================================================
   FIND STUDENT CLASS
===================================================== */
const users = JSON.parse(localStorage.getItem("users")) || [];
const studentRecord = users.find(
    u => u.login_id === loggedUser.login_id && u.role === "student"
);

if (!studentRecord) {
    alert("Student record not found.");
    location.href = "login.html";
}

const STUDENT_CLASS = studentRecord.class;

/* =====================================================
   LOAD ANNOUNCEMENTS
===================================================== */
function loadStudentAnnouncements() {
    const container = document.getElementById("studentAnnouncements");
    const emptyMsg = document.getElementById("studentAnnEmpty");

    const announcements =
        JSON.parse(localStorage.getItem("announcements")) || [];

    const relevant = announcements.filter(a => {
        if (!a.active || !a.target) return false;

        // 1️⃣ All students
        if (a.target.allStudents) return true;

        // 2️⃣ Student's class explicitly selected
        if (a.target.classes &&
            a.target.classes.includes(STUDENT_CLASS)) {
            return true;
        }

        // 3️⃣ Teachers-only announcements → students should NOT see
        return false;
    });

    container.innerHTML = "";
    emptyMsg.textContent = "";

    if (!relevant.length) {
        emptyMsg.textContent = "No announcements.";
        return;
    }

    relevant.forEach(a => {
        container.innerHTML += `
        <div class="card">
            <b>${a.title}</b><br>
            ${a.message}<br>
            <small>Posted on: ${formatDateToDDMonYYYY(a.time)}</small>
        </div>`;
    });
}


/* =====================================================
   LOAD NOTES
===================================================== */
function loadNotes() {
    const subjectFilter = subjectFilterEl.value;
    const materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];

    const filtered = materials.filter(m =>
        m.className === STUDENT_CLASS &&
        (!subjectFilter || m.subject === subjectFilter)
    );

    notesTable.innerHTML = "";
    notesEmpty.textContent = "";

    if (!filtered.length) {
        notesEmpty.textContent = "No notes available for your class.";
        return;
    }

    filtered.forEach(m => {
        notesTable.innerHTML += `
        <tr>
            <td data-label="Title">${m.title}</td>
            <td data-label="Subject">${m.subject}</td>
            <td data-label="Teacher">${m.uploaderName}</td>
            <td data-label="Description">${m.description || "-"}</td>
            <td data-label="File">
                <a href="${m.fileData}" download="${m.fileName}">${m.fileName}</a>
            </td>
            <td data-label="Uploaded On">${m.uploadedOn}</td>
        </tr>`;
    });
}

/* =====================================================
   LOAD HOMEWORK FOR STUDENT
===================================================== */
function loadStudentHomework() {
    const homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];

    const relevant = homeworks.filter(h =>
        h.className === STUDENT_CLASS
    );

    hwTable.innerHTML = "";
    hwEmpty.textContent = "";

    if (!relevant.length) {
        hwEmpty.textContent = "No homework assigned for your class.";
        return;
    }

    relevant.forEach(h => {
        hwTable.innerHTML += `
        <tr>
            <td data-label="Title">${h.title}</td>
            <td data-label="Subject">${h.subject}</td>
            <td data-label="Description">${h.description || "-"}</td>
            <td data-label="File">
                ${h.fileName
                    ? `<a href="${h.fileData}" download="${h.fileName}">${h.fileName}</a>`
                    : "-"
                }
            </td>
            <td data-label="Assigned On">${h.assignedOn}</td>
            <td data-label="Teacher">${h.uploaderName}</td>
        </tr>`;
    });
}

/* =====================================================
   INIT
===================================================== */
const subjectFilterEl = document.getElementById("subjectFilter");
const notesTable = document.getElementById("notesTable");
const notesEmpty = document.getElementById("notesEmpty");

const hwTable = document.getElementById("hwTable");
const hwEmpty = document.getElementById("hwEmpty");

populateSubjectDropdown("subjectFilter");
loadStudentAnnouncements();
loadNotes();

loadStudentHomework();

function formatDateToDDMonYYYY(timeString) {

    // ISO format → safe
    if (timeString.includes("T")) {
        const d = new Date(timeString);
        return d.toLocaleString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        }).replace(",", "");
    }

    // Old DD/MM/YYYY, HH:mm:ss format
    const [datePart, timePart] = timeString.split(", ");
    const [dd, mm, yyyy] = datePart.split("/");

    const d = new Date(`${yyyy}-${mm}-${dd}T${timePart}`);

    return d.toLocaleString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    }).replace(",", "");
}

</script>

<script src="footer.js"></script>
<script>
  renderFooter();
</script>

<script src="security.js"></script>

<script>
function toggleSection(sectionId, btn) {
    const section = document.getElementById(sectionId);
    const isHidden = section.style.display === "none";

    if (isHidden) {
        section.style.display = "block";
        btn.textContent = "▼";
    } else {
        section.style.display = "none";
        btn.textContent = "▲";
    }
}
</script>


</body>
</html>
