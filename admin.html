<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard â€“ Literacy LMS</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 10px;
}

/* ---------- Shared Header ---------- */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}
.top-bar h2 {
    margin: 0;
    font-size: 20px;
    color: #2c3e50;
}
.logout-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
}

/* ---------- Section ---------- */
.section {
    background: #fff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.section h3 { margin-top: 0; }

/* ---------- Table ---------- */
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 14px;
}
th { background: #f1f1f1; }

/* ---------- Buttons ---------- */
.btn {
    padding: 5px 8px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.approve { background: #2ecc71; color: white; }
.reject  { background: #e74c3c; color: white; }
.remove  { background: #c0392b; color: white; }
.post    { background: #3498db; color: white; }

.card {
    border: 1px solid #ddd;
    padding: 10px;
    margin-top: 8px;
    border-radius: 4px;
}
</style>





</head>

<body>

<!-- ================= SIGNUP REQUESTS ================= -->
<div class="section">
<h3>Signup Requests</h3>
<table>
<thead>
<tr>
<th>Name</th><th>Role</th><th>Class / Subject</th><th>Username</th><th>Actions</th>
</tr>
</thead>
<tbody id="requestTable"></tbody>
</table>
<div id="requestEmpty"></div>
</div>

<!-- ================= USERS ================= -->
<div class="section">
<h3>Approved Users</h3>
<table>
<thead>
<tr>
<th>Roll No</th><th>Name</th><th>Role</th><th>Class / Subject</th><th>Username</th><th>Actions</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
<div id="userEmpty"></div>
</div>

<!-- ================= ANNOUNCEMENTS ================= -->
<div class="section">
<h3>Create Announcement</h3>

<input id="annTitle" placeholder="Title"><br><br>
<textarea id="annMessage" rows="3" placeholder="Message"></textarea><br>

<label>
<input type="checkbox" id="annAll" checked onchange="toggleClassSelect()"> Send to all students
</label>

<div id="classSelectBox" style="display:none;">
    <strong>Select Classes:</strong><br>
    <label><input type="checkbox" value="6"> Class 6</label><br>
    <label><input type="checkbox" value="7"> Class 7</label><br>
    <label><input type="checkbox" value="8"> Class 8</label><br>
    <label><input type="checkbox" value="9"> Class 9</label><br>
    <label><input type="checkbox" value="10"> Class 10</label><br>
    <label><input type="checkbox" value="11"> Class 11</label><br>
    <label><input type="checkbox" value="12"> Class 12</label>


</div>

<button class="btn post" onclick="postAnnouncement()">Post</button>
</div>

<!-- ================= TEACHER NOTES ================= -->
<div class="section">
<h3>Teacher Uploaded Notes</h3>

<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>Teacher</th>
<th>Uploaded On</th>
<th>File</th>
</tr>
</thead>
<tbody id="adminNotesTable"></tbody>
</table>

<div id="adminNotesEmpty" class="empty"></div>
</div>

<!-- ================= TEACHER HOMEWORK ================= -->
<div class="section">
<h3>Teacher Assigned Homework</h3>

<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>Teacher</th>
<th>Assigned On</th>
<th>File</th>
</tr>
</thead>
<tbody id="adminHWTable"></tbody>
</table>

<div id="adminHWEmpty" class="empty"></div>
</div>

<!-- ================= TEACHER ATTENDANCE REPORT ================= -->
<div class="section">
<h3>Teacher Attendance Report</h3>

<label>Select Month</label>
<input type="month" id="attMonth" onchange="loadAttendanceReport()">

<table>
<thead>
<tr>
<th>Teacher</th>
<th>Present</th>
<th>Absent</th>
<th>Leave</th>
</tr>
</thead>
<tbody id="attReportTable"></tbody>
</table>

<div id="attReportEmpty" class="empty"></div>
</div>




<div class="section">
<h3>Posted Announcements</h3>
<div id="annList"></div>
</div>

<!-- âœ… SHARED SCRIPTS (ORDER MATTERS) -->
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="header.js"></script>

<script>
/* ROUTE PROTECTION */
const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
if (!loggedUser || loggedUser.role !== "admin") {
    alert("Unauthorized");
    location.href = "login.html";
}

/* HEADER */
renderHeader("Admin Dashboard");

/* ---------- ROLL NUMBER GENERATOR ---------- */
function generateRollNo(prefix) {
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const next = users.filter(u => u.roll_no && u.roll_no.startsWith(prefix)).length + 1;
    return prefix + String(next).padStart(4, "0");
}

/* ---------- LOAD SIGNUP REQUESTS ---------- */
function loadRequests() {
    const list = JSON.parse(localStorage.getItem("signupRequests")) || [];
    requestTable.innerHTML = list.map((r,i)=>`
        <tr>
            <td>${r.name}</td>
            <td>${r.role}</td>
            <td>${r.role === "student" ? r.class : r.subject}</td>
            <td>${r.login_id}</td>
            <td>
                <button class="btn approve" onclick="approve(${i})">Approve</button>
                <button class="btn reject" onclick="reject(${i})">Reject</button>
            </td>
        </tr>
    `).join("");
}

/* ---------- APPROVE USER ---------- */
function approve(i){
    if (!confirm("Are you sure you want to approve this user?")) {
        return;
    }

    const req = JSON.parse(localStorage.getItem("signupRequests")) || [];
    const users = JSON.parse(localStorage.getItem("users")) || [];

    const r = req.splice(i, 1)[0];

    if (r.role === "teacher") {
        r.roll_no = generateRollNo("LET");
    } else if (r.role === "student") {
        r.roll_no = generateRollNo("LES");
    }

    

    users.push(r);

    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("signupRequests", JSON.stringify(req));

    loadRequests();
    loadUsers();
}


/* ---------- REJECT USER ---------- */
function reject(i){
    const req = JSON.parse(localStorage.getItem("signupRequests")) || [];
    req.splice(i, 1);
    localStorage.setItem("signupRequests", JSON.stringify(req));
    loadRequests();
}

/* ---------- LOAD USERS ---------- */
function loadUsers(){
    const users = JSON.parse(localStorage.getItem("users")) || [];

    userTable.innerHTML = users.map((u,i)=>`
        <tr>
            <td>${u.roll_no || "-"}</td>
            <td>${u.name}</td>
            <td>${u.role}</td>
            <td>${u.class || u.subject || "-"}</td>
            <td>${u.login_id}</td>
            <td>
                ${u.role === "admin"
                    ? "Protected"
                    : `
                        <button class="btn remove"
                                onclick="removeUser(${i})">
                            Delete
                        </button>
                    `
                }
            </td>
        </tr>
    `).join("");
}



/* ---------- REMOVE USER ---------- */
function removeUser(i){
    if (!confirm("Are you sure you want to permanently delete this user?")) {
        return;
    }

    const users = JSON.parse(localStorage.getItem("users")) || [];
    users.splice(i, 1);
    localStorage.setItem("users", JSON.stringify(users));
    loadUsers();
}



/* ---------- ANNOUNCEMENTS ---------- */
function toggleClassSelect(){
    classSelectBox.style.display = annAll.checked ? "none" : "block";
}

function postAnnouncement(){
    const title = annTitle.value.trim();
    const message = annMessage.value.trim();

    if (!title || !message) {
        alert("Please enter title and message");
        return;
    }

    let targetClasses = ["ALL"];

    if (!annAll.checked) {
        const checked = [...classSelectBox.querySelectorAll("input[type=checkbox]:checked")]
                        .map(cb => cb.value);

        if (checked.length === 0) {
            alert("Please select at least one class");
            return;
        }

        targetClasses = checked;
    }

    const anns = JSON.parse(localStorage.getItem("announcements")) || [];

    anns.push({
        title,
        message,
        targetClasses,   // ðŸ‘ˆ IMPORTANT
        active: true,
        time: new Date().toLocaleString()
    });

    localStorage.setItem("announcements", JSON.stringify(anns));

    annTitle.value = "";
    annMessage.value = "";
    [...classSelectBox.querySelectorAll("input")].forEach(cb => cb.checked = false);
    annAll.checked = true;
    classSelectBox.style.display = "none";

    loadAnnouncements();
}


function loadAnnouncements(){
    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    annList.innerHTML = anns.map((a,i)=>`
        <div class="card">
            <b>${a.title}</b><br>
            <small>To: ${a.targetClasses.join(", ")}</small><br>
            ${a.message}<br>
            <button class="btn approve" onclick="toggleAnn(${i})">
                ${a.active ? "Deactivate" : "Activate"}
            </button>
            <button class="btn remove" onclick="deleteAnn(${i})">Delete</button>
        </div>
    `).join("");
}

function toggleAnn(i){
    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    anns[i].active = !anns[i].active;
    localStorage.setItem("announcements", JSON.stringify(anns));
    loadAnnouncements();
}

/* --------Delete Announcement with confirmation message ---------------*/
function deleteAnn(i){
    const proceed = confirm(
        "Are you sure you want to permanently delete this announcement?\n\nThis action cannot be undone."
    );

    if (!proceed) {
        return; // âŒ Stop deletion if admin cancels
    }

    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    anns.splice(i, 1);
    localStorage.setItem("announcements", JSON.stringify(anns));
    loadAnnouncements();
}


/* =====================================================
   VIEW ALL TEACHER NOTES (ADMIN)
===================================================== */
function loadAllTeacherNotes() {
    const materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];

    adminNotesTable.innerHTML = "";
    adminNotesEmpty.textContent = "";

    if (!materials.length) {
        adminNotesEmpty.textContent = "No notes uploaded by teachers.";
        return;
    }

    materials.forEach(m => {
        adminNotesTable.innerHTML += `
        <tr>
            <td>${m.title}</td>
            <td>${m.className}</td>
            <td>${m.subject}</td>
            <td>${m.uploaderName}</td>
            <td>${m.uploadedOn}</td>
            <td>
                <a href="${m.fileData}" download="${m.fileName}">
                    ${m.fileName}
                </a>
            </td>
        </tr>`;
    });
}

/* =====================================================
   VIEW ALL TEACHER HOMEWORK (ADMIN)
===================================================== */
function loadAllTeacherHomework() {
    const homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];

    adminHWTable.innerHTML = "";
    adminHWEmpty.textContent = "";

    if (!homeworks.length) {
        adminHWEmpty.textContent = "No homework assigned by teachers.";
        return;
    }

    homeworks.forEach(h => {
        adminHWTable.innerHTML += `
        <tr>
            <td>${h.title}</td>
            <td>${h.className}</td>
            <td>${h.subject}</td>
            <td>${h.uploaderName}</td>
            <td>${h.assignedOn}</td>
            <td>
                ${h.fileName
                    ? `<a href="${h.fileData}" download="${h.fileName}">
                        ${h.fileName}
                       </a>`
                    : "-"
                }
            </td>
        </tr>`;
    });
}

/* =====================================================
   LOAD ATTENDANCE REPORT (ADMIN)
===================================================== */
function loadAttendanceReport() {
    const month = document.getElementById("attMonth").value; // YYYY-MM
    if (!month) return;

    const attendance = JSON.parse(localStorage.getItem("attendance")) || [];

    const filtered = attendance.filter(a =>
        a.date.startsWith(month)
    );

    attReportTable.innerHTML = "";
    attReportEmpty.textContent = "";

    if (!filtered.length) {
        attReportEmpty.textContent = "No attendance records for this month.";
        return;
    }

    const summary = {};

    filtered.forEach(a => {
        if (!summary[a.teacherId]) {
            summary[a.teacherId] = {
                name: a.teacherName,
                Present: 0,
                Absent: 0,
                Leave: 0
            };
        }
        summary[a.teacherId][a.status]++;
    });

    Object.values(summary).forEach(s => {
        attReportTable.innerHTML += `
        <tr>
            <td>${s.name}</td>
            <td>${s.Present}</td>
            <td>${s.Absent}</td>
            <td>${s.Leave}</td>
        </tr>`;
    });
}




/* ---------- INIT ---------- */
loadRequests();
loadUsers();
loadAnnouncements();

loadAllTeacherNotes();
loadAllTeacherHomework();


</script>


<link rel="stylesheet" href="footer.css">
<script src="footer.js"></script>
<script>
  renderFooter();
</script>

<script src="security.js"></script>


</body>
</html>
