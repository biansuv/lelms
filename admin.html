<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Admin Dashboard – Literacy LMS</title>

<link rel="stylesheet" href="base.css">
<link rel="stylesheet" href="footer.css">
</head>

<body>

<!-- ================= SIGNUP REQUESTS ================= -->
<div class="section">
<h3 class="section-header attention">
    Signup Requests
    
    <button class="toggle-btn"
            onclick="toggleSection('signupReqBody', this)">
        ▲
    </button>
</h3>
<div id="signupReqBody"
     class="section-body"
     style="display:none;"
     data-loaded="false">


<table>
<thead>
<tr>
<th>Name</th><th>Role</th><th>Class / Subject</th><th>Username</th><th>Actions</th>
</tr>
</thead>
<tbody id="requestTable"></tbody>
</table>
<div id="requestEmpty"></div>
</div>
</div>

<!-- ================= USERS ================= -->
<div class="section">

<h3 class="section-header">
    Approved Users
    <button class="toggle-btn"
            onclick="toggleSection('approvedUsersBody', this)">
        ▲
    </button>
</h3>

<div id="approvedUsersBody" class="section-body" style="display:none;">

<table>

<thead>
<tr>
<th>Roll No</th><th>Name</th><th>Role</th><th>Class / Subject</th><th>Username</th><th>Actions</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
<div id="userEmpty"></div>
</div>
</div>

<!-- ================= ANNOUNCEMENTS ================= -->
<div class="section">

<h3 class="section-header">
    Create Announcement
    <button class="toggle-btn"
            onclick="toggleSection('announcementBody', this)">
        ▲
    </button>
</h3>

<div id="announcementBody" class="section-body" style="display:none;">
<input id="annTitle" placeholder="Title"><br><br>
<textarea id="annMessage" rows="3" placeholder="Message"></textarea><br>

<h4>Send Announcement To</h4>

<table class="target-table">
  <tr>
    <th>Target</th>
    <th>Select</th>
  </tr>

  <tr>
    <td>All Students (All Classes)</td>
    <td><input type="checkbox" id="targetAllStudents"
       onchange="handleAllStudentsToggle()"></td>
  </tr>

  <tr>
    <td>All Teachers</td>
    <td><input type="checkbox" id="targetTeachers"></td>
  </tr>

  <tr>
    <td>Class 6</td>
    <td><input type="checkbox" class="targetClass" value="6"></td>
  </tr>
  <tr>
    <td>Class 7</td>
    <td><input type="checkbox" class="targetClass" value="7"></td>
  </tr>
  <tr>
    <td>Class 8</td>
    <td><input type="checkbox" class="targetClass" value="8"></td>
  </tr>
  <tr>
    <td>Class 9</td>
    <td><input type="checkbox" class="targetClass" value="9"></td>
  </tr>
  <tr>
    <td>Class 10</td>
    <td><input type="checkbox" class="targetClass" value="10"></td>
  </tr>
  <tr>
    <td>Class 11</td>
    <td><input type="checkbox" class="targetClass" value="11"></td>
  </tr>
  <tr>
    <td>Class 12</td>
    <td><input type="checkbox" class="targetClass" value="12"></td>
  </tr>
</table>

<button class="btn post" onclick="postAnnouncement()">Post</button>
</div>
</div>

<div id="annPostMsg" class="empty"></div>


<!-- ================= TEACHER NOTES ================= -->
<div class="section">
<h3 class="section-header">
    Teacher Uploaded Notes
    <button class="toggle-btn"
            onclick="toggleSection('teacherNotesBody', this)">
        ▲
    </button>
</h3>
<div id="teacherNotesBody" class="section-body" style="display:none;">


<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>Teacher</th>
<th>Uploaded On</th>
<th>File</th>
</tr>
</thead>
<tbody id="adminNotesTable"></tbody>
</table>

<div id="adminNotesEmpty" class="empty"></div>
</div>
</div>

<!-- ================= TEACHER HOMEWORK ================= -->
<div class="section">
<h3 class="section-header">
    Teacher Assigned Homework
    <button class="toggle-btn"
            onclick="toggleSection('teacherHWBody', this)">
        ▲
    </button>
</h3>
<div id="teacherHWBody" class="section-body" style="display:none;">

<table>
<thead>
<tr>
<th>Title</th>
<th>Class</th>
<th>Subject</th>
<th>Teacher</th>
<th>Assigned On</th>
<th>File</th>
</tr>
</thead>
<tbody id="adminHWTable"></tbody>
</table>

<div id="adminHWEmpty" class="empty"></div>
</div>
</div>

<!-- ================= TEACHER ATTENDANCE REPORT ================= -->
<div class="section">
<h3 class="section-header">
    Teacher Attendance Report
    <button class="toggle-btn"
            onclick="toggleSection('attendanceBody', this)">
        ▲
    </button>
</h3>
<div id="attendanceBody" class="section-body" style="display:none;">


<label>Select Month</label>
<input type="month" id="attMonth" onchange="loadAttendanceReport()">

<table>
<thead>
<tr>
<th>Teacher</th>
<th>Present</th>
<th>Absent</th>
<th>Leave</th>
</tr>
</thead>
<tbody id="attReportTable"></tbody>
</table>

<div id="attReportEmpty" class="empty"></div>
</div>
</div>


<div class="section">
<h3 class="section-header">
    Posted Announcements
    <button class="toggle-btn"
            onclick="toggleSection('postedAnnBody', this)">
        ▲
    </button>
</h3>
<div id="postedAnnBody" class="section-body" style="display:none;">

<div id="annList"></div>
</div>
</div>

<!-- ✅ SHARED SCRIPTS (ORDER MATTERS) -->
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="header.js"></script>

<script>
/* ROUTE PROTECTION */
const loggedUser = JSON.parse(localStorage.getItem("loggedUser"));
if (!loggedUser || loggedUser.role !== "admin") {
    alert("Unauthorized");
    location.href = "login.html";
}

/* HEADER */
renderHeader("Admin Dashboard");

/* ---------- ROLL NUMBER GENERATOR ---------- */
function generateRollNo(prefix) {
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const next = users.filter(u => u.roll_no && u.roll_no.startsWith(prefix)).length + 1;
    return prefix + String(next).padStart(4, "0");
}

/* ---------- LOAD SIGNUP REQUESTS ---------- */
function loadRequests() {
    const list = JSON.parse(localStorage.getItem("signupRequests")) || [];

    requestTable.innerHTML = "";
    requestEmpty.textContent = "";

    if (!list.length) {
        requestEmpty.textContent = "No pending signup requests.";
        return;
    }

    requestTable.innerHTML = list.map((r, i) => `
        <tr>
            <td>${r.name}</td>
            <td>${r.role}</td>
            <td>${r.class || r.subject || "-"}</td>
            <td>${r.login_id}</td>
            <td>
                <button class="btn approve" onclick="approve(${i})">
                    Approve
                </button>
                <button class="btn remove" onclick="reject(${i})">
                    Reject
                </button>
            </td>
        </tr>
    `).join("");
}

/* ---------- APPROVE USER ---------- */
function approve(i){
    if (!confirm("Are you sure you want to approve this user?")) {
        return;
    }

    const req = JSON.parse(localStorage.getItem("signupRequests")) || [];
    const users = JSON.parse(localStorage.getItem("users")) || [];

    const r = req.splice(i, 1)[0];

    if (r.role === "teacher") {
        r.roll_no = generateRollNo("LET");
    } else if (r.role === "student") {
        r.roll_no = generateRollNo("LES");
    }

    users.push(r);

    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("signupRequests", JSON.stringify(req));

    loadRequests();
    loadUsers();
    
}

/* ---------- REJECT USER ---------- */
function reject(i){
    const req = JSON.parse(localStorage.getItem("signupRequests")) || [];
    req.splice(i, 1);
    localStorage.setItem("signupRequests", JSON.stringify(req));
    loadRequests();
    
}

/* ---------- LOAD USERS ---------- */
function loadUsers(){
    const users = JSON.parse(localStorage.getItem("users")) || [];

    userTable.innerHTML = users.map((u,i)=>`
        <tr>
            <td>${u.roll_no || "-"}</td>
            <td>${u.name}</td>
            <td>${u.role}</td>
            <td>${u.class || u.subject || "-"}</td>
            <td>${u.login_id}</td>
            <td>
                ${u.role === "admin"
                    ? "Protected"
                    : `
                        <button class="btn remove"
                                onclick="removeUser(${i})">
                            Delete
                        </button>
                    `
                }
            </td>
        </tr>
    `).join("");
}

/* ---------- REMOVE USER ---------- */
function removeUser(i){
    if (!confirm("Are you sure you want to permanently delete this user?")) {
        return;
    }

    const users = JSON.parse(localStorage.getItem("users")) || [];
    users.splice(i, 1);
    localStorage.setItem("users", JSON.stringify(users));
    loadUsers();
}

function handleAllStudentsToggle() {
    const allStudentsChecked =
        document.getElementById("targetAllStudents").checked;

    const classCheckboxes =
        document.querySelectorAll(".targetClass");

    classCheckboxes.forEach(cb => {
        cb.disabled = allStudentsChecked;

        if (allStudentsChecked) {
            cb.checked = false; // clear class selection
        }
    });
}

/* ---------- ANNOUNCEMENTS ---------- */

function postAnnouncement() {
    const title = annTitle.value.trim();
    const message = annMessage.value.trim();

    if (!title || !message) {
        alert("Please enter title and message");
        return;
    }

    const target = {
        allStudents: document.getElementById("targetAllStudents").checked,
        teachers: document.getElementById("targetTeachers").checked,
        classes: []
    };

    document.querySelectorAll(".targetClass:checked").forEach(cb => {
        target.classes.push(cb.value);
    });

    if (!target.allStudents && !target.teachers && target.classes.length === 0) {
        alert("Please select at least one target");
        return;
    }

    const confirmPost = confirm(
        "Are you sure you want to post this announcement?\n\n" +
        "This message will be visible immediately to the selected users."
    );

    if (!confirmPost) return;

    const anns = JSON.parse(localStorage.getItem("announcements")) || [];

    // ✅ PUSH ANNOUNCEMENT (DATA ONLY)
    anns.push({
        title,
        message,
        target,
        active: true,
        time: new Date().toISOString()
    });

    localStorage.setItem("announcements", JSON.stringify(anns));

    // ✅ SUCCESS MESSAGE (UI)
    const msg = document.getElementById("annPostMsg");
    msg.textContent = "✅ Announcement posted successfully.";

    setTimeout(() => {
        msg.textContent = "";
    }, 3000);

    // ✅ RESET FORM
    annTitle.value = "";
    annMessage.value = "";
    document
        .querySelectorAll(".target-table input[type=checkbox]")
        .forEach(cb => {
            cb.checked = false;
            cb.disabled = false; // re-enable class checkboxes
        });

    loadAnnouncements();
}

function loadAnnouncements(){
    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    annList.innerHTML = anns.map((a,i)=>`
        <div class="card">
            <b>${a.title}</b><br>
            <small>
To:
${a.target.allStudents ? " All Students " : ""}
${a.target.teachers ? " All Teachers " : ""}
${a.target.classes.length ? " Classes " + a.target.classes.join(", ") : ""}
</small>

            ${a.message}<br>
            <button class="btn approve" onclick="toggleAnn(${i})">
                ${a.active ? "Deactivate" : "Activate"}
            </button>
            <button class="btn remove" onclick="deleteAnn(${i})">Delete</button>
        </div>
    `).join("");
}

function toggleAnn(i){
    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    anns[i].active = !anns[i].active;
    localStorage.setItem("announcements", JSON.stringify(anns));
    loadAnnouncements();
}

/* --------Delete Announcement with confirmation message ---------------*/
function deleteAnn(i){
    const proceed = confirm(
        "Are you sure you want to permanently delete this announcement?\n\nThis action cannot be undone."
    );

    if (!proceed) {
        return; // ❌ Stop deletion if admin cancels
    }

    const anns = JSON.parse(localStorage.getItem("announcements")) || [];
    anns.splice(i, 1);
    localStorage.setItem("announcements", JSON.stringify(anns));
    loadAnnouncements();
}

/* =====================================================
   VIEW ALL TEACHER NOTES (ADMIN)
===================================================== */
function loadAllTeacherNotes() {
    const materials = JSON.parse(localStorage.getItem("studyMaterials")) || [];

    adminNotesTable.innerHTML = "";
    adminNotesEmpty.textContent = "";

    if (!materials.length) {
        adminNotesEmpty.textContent = "No notes uploaded by teachers.";
        return;
    }

    materials.forEach(m => {
        adminNotesTable.innerHTML += `
        <tr>
            <td>${m.title}</td>
            <td>${m.className}</td>
            <td>${m.subject}</td>
            <td>${m.uploaderName}</td>
            <td>${m.uploadedOn}</td>
            <td>
                <a href="${m.fileData}" download="${m.fileName}">
                    ${m.fileName}
                </a>
            </td>
        </tr>`;
    });
}

/* =====================================================
   VIEW ALL TEACHER HOMEWORK (ADMIN)
===================================================== */
function loadAllTeacherHomework() {
    const homeworks = JSON.parse(localStorage.getItem("homeworks")) || [];

    adminHWTable.innerHTML = "";
    adminHWEmpty.textContent = "";

    if (!homeworks.length) {
        adminHWEmpty.textContent = "No homework assigned by teachers.";
        return;
    }

    homeworks.forEach(h => {
        adminHWTable.innerHTML += `
        <tr>
            <td>${h.title}</td>
            <td>${h.className}</td>
            <td>${h.subject}</td>
            <td>${h.uploaderName}</td>
            <td>${h.assignedOn}</td>
            <td>
                ${h.fileName
                    ? `<a href="${h.fileData}" download="${h.fileName}">
                        ${h.fileName}
                       </a>`
                    : "-"
                }
            </td>
        </tr>`;
    });
}

/* =====================================================
   LOAD ATTENDANCE REPORT (ADMIN)
===================================================== */
function loadAttendanceReport() {
    const month = document.getElementById("attMonth").value; // YYYY-MM
    if (!month) return;

    const attendance = JSON.parse(localStorage.getItem("attendance")) || [];

    const filtered = attendance.filter(a =>
        a.date.startsWith(month)
    );

    attReportTable.innerHTML = "";
    attReportEmpty.textContent = "";

    if (!filtered.length) {
        attReportEmpty.textContent = "No attendance records for this month.";
        return;
    }

    const summary = {};

    filtered.forEach(a => {
        if (!summary[a.teacherId]) {
            summary[a.teacherId] = {
                name: a.teacherName,
                Present: 0,
                Absent: 0,
                Leave: 0
            };
        }
        summary[a.teacherId][a.status]++;
    });

    Object.values(summary).forEach(s => {
        attReportTable.innerHTML += `
        <tr>
            <td>${s.name}</td>
            <td>${s.Present}</td>
            <td>${s.Absent}</td>
            <td>${s.Leave}</td>
        </tr>`;
    });
}

function formatDateToDDMonYYYY(isoString) {
    const date = new Date(isoString);

    const day = String(date.getDate()).padStart(2, "0");
    const month = date.toLocaleString("en-GB", { month: "short" });
    const year = date.getFullYear();

    const time = date.toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit"
    });

    return `${day}-${month}-${year}, ${time}`;
}

/* ---------- INIT ---------- */
loadRequests();
loadUsers();
loadAnnouncements();
loadAllTeacherNotes();
loadAllTeacherHomework();

</script>

<script src="footer.js"></script>
<script>
  renderFooter();
</script>

<script src="security.js"></script>

<script>
/* =====================================================
   SECTION TOGGLE (Shared with Teacher)
===================================================== */

function toggleSection(sectionId, btn) {
    const section = document.getElementById(sectionId);

    if (section.style.display === "none") {
        section.style.display = "block";
        btn.textContent = "▼";
    } else {
        section.style.display = "none";
        btn.textContent = "▲";
    }
}


</script>

</body>
</html>
